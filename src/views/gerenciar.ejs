<%- include includes/header %>
<div class="main-formulario-seo">
     <h2>Gerenciar Espaço</h2>
     <p>Prencha as informações abaixo</p>
     <div class="container p-3" id="FormUpdateEspacoDiv">
         <div id="loader" class="text-center">
             <div class="spinner-border" role="status">
                 <span class="visually-hidden">Carregando...</span>
             </div>
         </div>
 
         <div id="response_notification"></div>
 
         <form id="FormUpdateEspaco" class="row g-3 text-center justify-content-center" enctype="multipart/form-data" method="post" action="#FormUpdateEspacoDiv">
             <div class="col-12">
                 <input name="nome" type="text" class="form-control" id="formName" placeholder="Nome*" aria-required="true" value="<%=lugar.nome%>">
             </div> 
             <div class="col-12">
                 <input name="description" type="text" class="form-control" id="formDesc" placeholder="Descrição*" value="<%=lugar.description%>"  aria-required="true">
             </div> 
             <div class="col-12">
                 <textarea name="descricao_longa" type="text" class="form-control" id="formLongDesc" placeholder="Descrição Longa*" aria-required="true" rows="5"><%=lugar.descricao_longa%></textarea>
            </div> 
            <div class="col-12">
                <input name="price" type="number" class="form-control" id="formPrice" placeholder="Preço*" aria-required="true" value="<%=lugar.price%>">
            </div> 
            <div class="col-12">
                <input name="location" type="text" class="form-control" id="formLocation" placeholder="Endereço*" value="<%=lugar.location%>"  aria-required="true">
            </div> 

            <% 
              count = 0;
              lugar.datas_disponiveis.forEach(datas => { 
              if(datas != null) {
            %>
              

            <% if(count == 0 ) { %> 
              <div class="col-12 d-flex flex-wrap clone linha_data"> 
            <% } else { %>
              <div class="col-12 d-flex flex-wrap linha_data"> 
            <% } %>
                <div class="col-10 pe-2">
                  <input name="datas_disponiveis[<%=count%>]" type="date" class="form-control" id="formDate[<%=count%>]" placeholder="Data Disponivel*" value="<%=datas%>"  aria-required="true">
                </div>
                <div class="col-2">
                  <button type="button" title="remover" class="btn button-remove btn-danger col-md-12">
                    <i class="fas fa-remove"></i>
                  </button>
                </div>
              </div>
            <% 
              count++; }});
            %>

            <div class="row">&nbsp;</div>
            <div class="row">
                <div class="col-xs-12 col-sm-12 col-lg-12 col-md-12">
                    <button type="button" class="btn button-more btn-success pull-right">
                    <i class="fas fa-plus-circle"></i> Mais
                    </button>
                </div>
            </div>


            <div class="col-12">
              <div class="form-check">
                <% if(lugar.status) { %>
                  <input class="form-check-input" name='status' type="checkbox" id="flexCheckStatus" checked>
                <% } else { %>
                  <input class="form-check-input" name='status' type="checkbox" id="flexCheckStatus">
                <% } %>
                <label class="form-check-label" for="flexCheckStatus">
                  Ativado (<%=lugar.status%>)
                </label>
              </div>
            </div>
            <div class="col-12">
            <input class="form-control" type="file" id="formImage" name="thumbnail">
            </div>
            <div class="col-12">
                <button id="BTEnvia" type="submit" name="BTEnvia" class="btn_formulario d-inline-flex align-items-center gap-2"><i class="fas fa-paper-plane"></i>Enviar</button>
            </div>
         </form>
     </div>
 </div>

<script>
    var nrQtdProduto = 1;
    // var nrQtdProdutoRep = 0;
$(function() 
{

  $('.button-more').click(function() {
    var $objDivProduto = $(this).parent().parent().parent().children('.clone');
    nrQtdProduto = $(this).parent().parent().parent().children('.linha_data').length;
    // nrQtdProdutoRep = nrQtdProduto-1

    $objDivProduto
      .clone()
      .removeClass('clone')
      .find('input').each(function(k, v) {
        var strName = $(v).attr('name');
        var strId = $(v).attr('id');

        $(this)
          .attr('name', strName.replace('[0]', '['+ nrQtdProduto + ']'))
          .attr('id', strId.replace('[0]', '['+ nrQtdProduto + ']'));

        if ($(this).attr('type') != 'hidden') {
          $(this).val('');
        }

      })
      .end()
      .insertAfter($objDivProduto);
  });

});


$('.button-remove').click(function() {

nrQtdProduto = $(this).parent().parent().parent().children('.linha_data').length ;

if (nrQtdProduto == 1) {
  alert('Erro - Você deve ter ao menos um campo para cadastro.');
  return;
}

if (confirm('Deseja realmente remover a linha ?')) {
  var objRemove = $(this).parent().parent();
  objRemove.remove();
}
});



</script>

<script>

    function convertFormToJSON(form) {
        const array = $(form).serializeArray(); // Encodes the set of form elements as an array of names and values.
        const json = {};
        $.each(array, function () {
            json[this.name] = this.value || "";
        });
        return json;
    }

     $(document).ready(function() {
          var request;

          $('#FormUpdateEspaco').submit(function (event) {
              // Prevent default posting of form - put here to work in case of errors
              event.preventDefault();

              // Abort any pending request
              if (request) {
                   request.abort();
              }

              var $form = $(this);
              var today = new Date();
              var dd = String(today.getDate()).padStart(2, '0');
              var mm = String(today.getMonth() + 1).padStart(2, '0'); // January is 0!
              var yyyy = today.getFullYear();

              today = yyyy + '-' + mm + '-' + dd

              var formData = new FormData(this);
              console.log(formData);

              $.ajax({
                   type: 'POST',
                   url: '<%=Url%>places/<%=id_lugar%>',
                   // contentType: 'multipart/form-data; boundary=0258866893',
                   contentType: false,
                   // contentType: 'application/json',
                   processData: false,

                   data: formData,
                   // await: true,
                   // dataType: 'json',
                   beforeSend: function () {
                        $("#FormUpdateEspaco").css("opacity", 0.6);
                        $('#loader').show();
                   },
                   success: function(response) {
                        $('#response_notification').html('<div class="alert alert-success alerta-email" role="alert"><i class="fas fa-check-circle me-3"></i>Espaço atualizado com sucesso</div>');
                   },
                   error: function(response) {
                        $('#response_notification').html('<div class="alert alert-danger" role="alert"><i class="fas fa-exclamation-circle me-3"></i>' + response.responseJSON.error + '</div>');
                        console.log(response);
                   },          
                   complete: function () {
                        $('#loader').hide();
                        $("#FormUpdateEspaco").css("opacity", 1);
                        $('.alert').fadeIn('slow');
                   }
              });
          });
     });

</script>
<%- include includes/footer %>